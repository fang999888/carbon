// DOM 元素 - 模式輸入
const generalInput = document.getElementById('generalInput');
const generalSendBtn = document.getElementById('generalSendBtn');
const industryName = document.getElementById('industryName');
const industryProcess = document.getElementById('industryProcess');
const industrySendBtn = document.getElementById('industrySendBtn');
const sourceDesc = document.getElementById('sourceDesc');
const activityData = document.getElementById('activityData');
const calculationSendBtn = document.getElementById('calculationSendBtn');

// 模式切換功能
modeBtns.forEach(btn => {
    btn.addEventListener('click', function() {
        // 移除所有 active 類別
        modeBtns.forEach(b => b.classList.remove('active'));
        modeInputSections.forEach(s => s.classList.remove('active-mode'));
        
        // 為當前按鈕加上 active 類別
        this.classList.add('active');
        
        // 顯示對應的輸入區塊
        const mode = this.dataset.mode;
        if (mode === 'general') {
            document.getElementById('general-input').classList.add('active-mode');
        } else if (mode === 'industry') {
            document.getElementById('industry-input').classList.add('active-mode');
        } else if (mode === 'calculation') {
            document.getElementById('calculation-input').classList.add('active-mode');
        }
    });
});

// 一般諮詢發送
generalSendBtn.addEventListener('click', async () => {
    const message = generalInput.value.trim();
    if (!message) return;
    
    addMessage('user', message);
    generalInput.value = '';
    await processMessage('/api/chat', { message, history: conversationHistory.slice(-10) });
});

// 行業分析發送
industrySendBtn.addEventListener('click', async () => {
    const industry = industryName.value.trim();
    if (!industry) {
        alert('請輸入行業名稱');
        return;
    }
    
    const process = industryProcess.value.trim();
    const message = `【行業分析】${industry}${process ? ' - ' + process : ''}`;
    addMessage('user', message);
    
    industryName.value = '';
    industryProcess.value = '';
    
    await processMessage('/api/analyze-industry', { 
        industry: industry, 
        process_description: process 
    });
});

// 排放計算發送
calculationSendBtn.addEventListener('click', async () => {
    const source = sourceDesc.value.trim();
    const data = activityData.value.trim();
    
    if (!source || !data) {
        alert('請輸入排放源描述和活動數據');
        return;
    }
    
    const message = `【排放計算】${source} - ${data}`;
    addMessage('user', message);
    
    sourceDesc.value = '';
    activityData.value = '';
    
    await processMessage('/api/calculate-emission', { 
        emission_source: `${source} ${data}`,
        activity_data: { description: `${source} ${data}` }
    });
});

// 統一的訊息處理函數
async function processMessage(apiUrl, payload) {
    const loadingId = 'loading-' + Date.now();
    const loadingDiv = document.createElement('div');
    loadingDiv.classList.add('message', 'bot');
    loadingDiv.id = loadingId;
    loadingDiv.innerHTML = '<div class="bubble">⏳ 專家思考中...</div>';
    conversationDiv.appendChild(loadingDiv);

    try {
        console.log('發送請求到:', apiUrl, payload);
        
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(payload)
        });
        
        const loading = document.getElementById(loadingId);
        if (loading) loading.remove();

        if (response.ok) {
            const data = await response.json();
            const reply = data.reply || data.analysis || data.calculation || JSON.stringify(data);
            addMessage('assistant', reply);
        } else {
            addMessage('assistant', `⚠️ 錯誤 (${response.status})：無法連接到專家系統`);
        }
    } catch (error) {
        const loading = document.getElementById(loadingId);
        if (loading) loading.remove();
        addMessage('assistant', '⚠️ 連線錯誤，請稍後再試');
    }
}
